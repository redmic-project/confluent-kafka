include:
  - project: 'redmic-project/gitlab-ci-templates'
    ref: master
    file: '/_deployment.yml'

stages:
  - deploy

variables:
  PROJECT_PARENT_NAME: confluent

.deploy-development:
  environment:
    name: dev/${SERVICE_NAME}

.deploy-production:
  environment:
    name: pro/${SERVICE_NAME}

.deploy-kf-1:
  variables: &deploy-kf-1-variables
    SERVICE_NAME: kf-1
    SERVICES_TO_CHECK: ${PROJECT_PARENT_NAME}_${CI_PROJECT_NAME}-1

.deploy-kf-2:
  variables: &deploy-kf-2-variables
    SERVICE_NAME: kf-2
    SERVICES_TO_CHECK: ${PROJECT_PARENT_NAME}_${CI_PROJECT_NAME}-2

.deploy-kf-3:
  variables: &deploy-kf-3-variables
    SERVICE_NAME: kf-3
    SERVICES_TO_CHECK: ${PROJECT_PARENT_NAME}_${CI_PROJECT_NAME}-3

.deploy-kf-1-development:
  extends: .deploy-development
  variables:
    COMPOSE_FILE: docker-compose.${CI_PROJECT_NAME}-1.tmpl.yml:docker-compose.${CI_PROJECT_NAME}-1.dev.yml
    <<: *deploy-kf-1-variables

.deploy-kf-2-development:
  extends: .deploy-development
  variables:
    COMPOSE_FILE: docker-compose.${CI_PROJECT_NAME}-2.tmpl.yml:docker-compose.${CI_PROJECT_NAME}-2.dev.yml
    <<: *deploy-kf-2-variables

.deploy-kf-3-development:
  extends: .deploy-development
  variables:
    COMPOSE_FILE: docker-compose.${CI_PROJECT_NAME}-3.tmpl.yml:docker-compose.${CI_PROJECT_NAME}-3.dev.yml
    <<: *deploy-kf-3-variables

.deploy-kf-1-production:
  extends: .deploy-production
  variables:
    COMPOSE_FILE: docker-compose.${CI_PROJECT_NAME}-1.tmpl.yml:docker-compose.${CI_PROJECT_NAME}-1.prod.yml
    <<: *deploy-kf-1-variables

.deploy-kf-2-production:
  extends: .deploy-production
  variables:
    COMPOSE_FILE: docker-compose.${CI_PROJECT_NAME}-2.tmpl.yml:docker-compose.${CI_PROJECT_NAME}-2.prod.yml
    <<: *deploy-kf-2-variables

.deploy-kf-3-production:
  extends: .deploy-production
  variables:
    COMPOSE_FILE: docker-compose.${CI_PROJECT_NAME}-3.tmpl.yml:docker-compose.${CI_PROJECT_NAME}-3.prod.yml
    <<: *deploy-kf-3-variables

.deploy-support-branch: &deploy-support-branch
  only:
    - branches
  except:
    - master
    - schedules

deploy-kf-1-support-branch-development:
  extends: .deploy-kf-1-development
  variables:
    <<: *deploy-branch-base-variables
  <<: *deploy-support-branch

deploy-kf-2-support-branch-development:
  extends: .deploy-kf-2-development
  variables:
    <<: *deploy-branch-base-variables
  <<: *deploy-support-branch

deploy-kf-3-support-branch-development:
  extends: .deploy-kf-3-development
  variables:
    <<: *deploy-branch-base-variables
  <<: *deploy-support-branch

.deploy-stable-branch: &deploy-stable-branch
  only:
    - master
  except:
    - schedules

deploy-kf-1-stable-branch-development:
  extends: .deploy-kf-1-development
  variables:
    <<: *deploy-branch-base-variables
  <<: *deploy-stable-branch

deploy-kf-2-stable-branch-development:
  extends: .deploy-kf-2-development
  variables:
    <<: *deploy-branch-base-variables
  <<: *deploy-stable-branch

deploy-kf-3-stable-branch-development:
  extends: .deploy-kf-3-development
  variables:
    <<: *deploy-branch-base-variables
  <<: *deploy-stable-branch

deploy-kf-1-stable-branch-production:
  extends: .deploy-kf-1-production
  variables:
    <<: *deploy-branch-base-variables
  <<: *deploy-stable-branch

deploy-kf-2-stable-branch-production:
  extends: .deploy-kf-2-production
  variables:
    <<: *deploy-branch-base-variables
  <<: *deploy-stable-branch

deploy-kf-3-stable-branch-production:
  extends: .deploy-kf-3-production
  variables:
    <<: *deploy-branch-base-variables
  <<: *deploy-stable-branch

.deploy-tag: &deploy-tag
  only:
    - tags

deploy-kf-1-tag-development:
  extends: .deploy-kf-1-development
  <<: *deploy-tag

deploy-kf-2-tag-development:
  extends: .deploy-kf-2-development
  <<: *deploy-tag

deploy-kf-3-tag-development:
  extends: .deploy-kf-3-development
  <<: *deploy-tag

deploy-kf-1-tag-production:
  extends: .deploy-kf-1-production
  <<: *deploy-tag

deploy-kf-2-tag-production:
  extends: .deploy-kf-2-production
  <<: *deploy-tag

deploy-kf-3-tag-production:
  extends: .deploy-kf-3-production
  <<: *deploy-tag
